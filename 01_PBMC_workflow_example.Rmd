---
title: "Data Analysis Workflow Example Using MEM on PBMC Data (t-SNE, UMAP, FlowSOM, MEM)"
author: "Copyright (c) 2016-2019 by Kirsten Diggins, Sierra Barone, and Jonathan Irish, All Rights Reserved; see EULA-MEM.text for MEM license information"
date: "July 2019"
output:
  pdf_document:
    latex_engine: xelatex
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: inline
---

This data set contains 7 FCS (flow cytometry standard) files. Each FCS file 
contains single cell data for one cell subset that is a well-established, 
phenotypically distinct population. This is mass cytometry data for healthy 
human PBMC (peripheral blood mononuclear cells). The populations were expert 
gated following a t-SNE analysis. The first section of the code will run two
dimensionality reduction tools, UMAP and t-SNE, on the data set. Next, you 
will run FlowSOM on the UMAP axes to cluster the islands of cell populations.
Finally, you will run MEM to see enrichment scores for each of the FlowSOM
clusters. The goal of this exercise is to run several computational tools on
a single cell data set to get a feel for the workflow used in the Irish lab. 

```{r setup, include=FALSE}
# Time <10 sec

# Load all libraries
# If you get an error message, you will need to try re-installing packages by 
# going back to the 00_install_tools.RMD script
library(FlowSOM)
library(flowCore)
library(Biobase)
library(ggplot2)
library(hexbin)
library(MEM)
library(tidyverse)
library(Rtsne)
library(uwot)
library(viridis)
library(ggExtra)
```

```{r data_preparation, warning=FALSE}
# Time <10 sec

# read files into R by setting working directory and directing R to the fcs files
setwd(paste(getwd(), "/datafiles/PBMC", sep = ""))
files <-  dir(pattern = "*.fcs")

# prepare data for use in downstream analysis
data <- lapply(lapply(files, read.FCS), exprs)
ID <- c(1:length(data))
combined.data = as.data.frame(do.call(rbind, mapply(
  cbind, data, "File ID" = ID, SIMPLIFY = F
)))

# choose markers to use for downstream analysis and apply arcsinh
# transformation with a cofactor of 15

# to see all columns, uncomment line below (line 62)
# colnames(combined.data)
chosen.markers = combined.data[, c(12:20, 22:23, 25:33, 35:36, 38:40)] # columns to use

transformed.chosen.markers <- chosen.markers %>%
  mutate_all(function(x)
    asinh(x / 15))        # cofactor here is 15; this can be changed

# set seed for reproducible results (43 is chosen below)
overall_seed = 43
```

```{r run_t-SNE}
# Time ~5 min

set.seed(overall_seed)

# the line below will run t-SNE on the scaled surface markers (to see help page for t-SNE, type "?Rtsne -- enter" in console)
mytSNE = Rtsne(
  transformed.chosen.markers,                        # input scaled data
  dims = 2,                                          # number of final dimensions
  initial_dims = length(transformed.chosen.markers), # number of initial dimensions
  perplexity = 30,          # perplexity (similar to # of nearest neighbors, 
                            # will scale with data sets, cannot be greater than
                            # the number of events minus 1 divided by 3)
  check_duplicates = FALSE, 
  max_iter = 1000           # number of iterations
)
tsne.data = as.data.frame(mytSNE$Y)
```

```{r plot_t-SNE}
# Time <10 sec

# setting aspect ratio for plots
range <- apply(apply(tsne.data, 2, range), 2, diff)
graphical.ratio <- (range[1] / range[2])

# t-SNE flat dot plot and density dot plot (1 dot = 1 cell)
tsne.plot <- data.frame(x = tsne.data[, 1], y = tsne.data[, 2])

# dot plot
ggplot(tsne.plot) + coord_fixed(ratio = graphical.ratio) + 
  geom_point(aes(x = x, y = y), cex = 1) + labs(x = "t-SNE 1", y = "t-SNE 2", 
                                                title = "t-SNE on PBMC Data") + 
  theme_bw() + 
  labs(caption = "Data from Digggins et al., Nat Methods 2017, 14: 275-278 \nFlow Repository: FR-FCM-ZY63")

# density dot plot
ggplot(tsne.plot, aes(x = x, y = y)) + coord_fixed(ratio = graphical.ratio)  + 
  geom_bin2d(bins = 128) +
  scale_fill_viridis_c(option = "A", trans = "sqrt") + 
  scale_x_continuous(expand = c(0.1, 0)) +
  scale_y_continuous(expand = c(0.1, 0)) + labs(x = "t-SNE 1", y = "t-SNE 2", 
                                                title = "t-SNE on PBMC Data") + 
  theme_bw() + 
  labs(caption = "Data from Diggins et al., Nat Methods 2017, 14: 275-278 \nFlow Repository: FR-FCM-ZY63")
```

```{r run_UMAP}
# Time ~1 min

# Run UMAP on all scaled surface markers
set.seed(overall_seed)

# the line below will run UMAP on the data set (to see help page for UMAP, type "UMAP -- enter" in console)
myumap <-
  umap(transformed.chosen.markers,  # input scaled data
       n_threads = 1,               # this argument makes UMAP reproducible
       verbose = TRUE)
umap.data = as.data.frame(myumap$embedding)
```

```{r plot_UMAP}
# Time <10 sec

# setting aspect ratio for plots
range <- apply(apply(umap.data, 2, range), 2, diff)
graphical.ratio <- (range[1] / range[2])

# UMAP flat dot plot and density dot plot (1 dot = 1 cell)
UMAP.plot <- data.frame(x = umap.data[, 1], y = umap.data[, 2])

# dot plot
ggplot(UMAP.plot) + coord_fixed(ratio = graphical.ratio) + 
  geom_point(aes(x = x, y = y), cex = 1) + labs(x = "UMAP 1", y = "UMAP 2", 
                                                title = "UMAP on PBMC Data") + 
  theme_bw() + 
  labs(caption = "Data from Digggins et al., Nat Methods 2017, 14: 275-278 \nFlow Repository: FR-FCM-ZY63")

# density dot plot
ggplot(UMAP.plot, aes(x = x, y = y)) + coord_fixed(ratio = graphical.ratio)  + 
  geom_bin2d(bins = 128) +
  scale_fill_viridis_c(option = "A", trans = "sqrt") + 
  scale_x_continuous(expand = c(0.1, 0)) +
  scale_y_continuous(expand = c(0.1, 0)) + labs(x = "UMAP 1", y = "UMAP 2", 
                                                title = "UMAP on PBMC Data") + 
  theme_bw() + 
  labs(caption = "Data from Diggins et al., Nat Methods 2017, 14: 275-278 \nFlow Repository: FR-FCM-ZY63")
```

```{r run_FlowSOM}
# Time <10 sec

# create flowFrame for FlowSOM input (using umap axes as input)
matrix <- as.matrix(umap.data)
metadata <-
  data.frame(name = dimnames(matrix)[[2]],
             desc = paste('UMAP', dimnames(matrix)[[2]]))
metadata$range <- apply(apply(matrix, 2, range), 2, diff)
metadata$minRange <- apply(matrix, 2, min)
metadata$maxRange <- apply(matrix, 2, max)
flowframe <- new("flowFrame",
                      exprs = matrix,
                      parameters = AnnotatedDataFrame(metadata))

# implement the FlowSOM on the data by running the line below (to see help page for FlowSOM, type "FlowSOM -- enter" in console)
fsom <-
  FlowSOM(
    umap.flowframe,      # input flowframe 
    colsToUse = c(1:2),  # columns to use 
    nClus = 9,          # target number of clusters (this can be changed)
    seed = overall_seed  # set seed for reproducibility
  )
FlowSOM.clusters <-
  as.matrix(fsom[[2]][fsom[[1]]$map$mapping[, 1]])
```

```{r plot_clusters}
# Time <10 sec

# plot FlowSOM clusters on UMAP axes
ggplot(UMAP.plot) + coord_fixed(ratio=graphical.ratio) + 
  geom_point(aes(x=x, y=y, color=FlowSOM.clusters)) + 
  labs(x = "UMAP 1", y = "UMAP 2",title = "FlowSOM Clustering on UMAP Axes", 
       color = "FlowSOM Cluster") + theme_bw() + 
  guides(colour = guide_legend(override.aes = list(size=3)))+
  labs(caption = "Data from Diggins et al., Nat Methods 2017, 14: 275-278 \nFlow Repository: FR-FCM-ZY63")
```

```{r run_MEM}
# Time ~30 sec

# Run MEM on the FlowSOM clusters found from using UMAP axes
cluster = as.numeric(as.vector((FlowSOM.clusters)))
MEM.data = cbind(transformed.chosen.markers, cluster)

MEM.values = MEM(
  MEM.data,              # input data (last column must contain cluster values)
  transform = FALSE,     # data is already scaled in this case
  cofactor = 1,
  choose.markers = FALSE,
  markers = "all",       # use all transformed, chosen markers from previous selection
  choose.ref = FALSE,    # reference will be all other cells
  zero.ref = FALSE,
  rename.markers = FALSE,
  new.marker.names = "CD19,CD117,CD11b,CD4,CD8,CD20,CD34,CD61,CD123,CD45RA,CD45,CD10,CD33,CD11c,CD14,CD69,CD15,CD16,CD44,CD38,CD25,CD3,IgM,HLA-DR,CD56", # rename channels for labels
  file.is.clust = FALSE,
  add.fileID = FALSE,
  IQR.thresh = NULL
)

# build MEM heatmap and output enrichment scores
build.heatmaps(
  MEM.values,                   # input MEM values
  cluster.MEM = "both",         # dendrogram for columns and rows
  display.thresh = 3,           # display threshold for MEM scores
  newWindow.heatmaps = TRUE,
  output.files = TRUE,          # makes txt and PDF files for heatmap and MEM scores
  labels = TRUE,                # include labels in heatmap
  only.MEMheatmap = FALSE
)
```


